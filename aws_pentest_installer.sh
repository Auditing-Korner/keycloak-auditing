#!/bin/bash

# AWS Penetration Testing Tools Installer for Ubuntu 24.04
# Author: RFS - Security Researcher
# Version: 2.0
# Description: Automated installer for AWS pentesting tools

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Tool directories
TOOLS_DIR="$HOME/aws-pentest-tools"
LOG_FILE="$TOOLS_DIR/installation.log"

# Function to print colored output
print_status() {
    echo -e "${GREEN}[+]${NC} $1"
}

print_info() {
    echo -e "${BLUE}[*]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

print_error() {
    echo -e "${RED}[-]${NC} $1"
}

# Function to log commands
log_command() {
    echo "$(date): Executing: $1" >> "$LOG_FILE"
    eval "$1" 2>&1 | tee -a "$LOG_FILE"
}

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to create directories
setup_directories() {
    print_status "Setting up directory structure..."
    mkdir -p "$TOOLS_DIR"
    mkdir -p "$TOOLS_DIR/bin"
    mkdir -p "$TOOLS_DIR/wordlists"
    mkdir -p "$TOOLS_DIR/reports"
    mkdir -p "$TOOLS_DIR/scripts"
    
    # Create log file
    touch "$LOG_FILE"
    chmod 644 "$LOG_FILE"
    
    print_info "Tools will be installed in: $TOOLS_DIR"
}

# Function to update system packages
update_system() {
    print_status "Updating system packages..."
    log_command "sudo apt update"
    log_command "sudo apt upgrade -y"
}

# Function to install system dependencies
install_system_dependencies() {
    print_status "Installing system dependencies..."
    
    local packages=(
        "curl" "wget" "git" "unzip" "build-essential" "python3" "python3-pip" 
        "python3-venv" "python3-dev" "golang-go" "nodejs" "npm" "jq" "nmap" 
        "dnsutils" "whois" "ncat" "masscan" "subfinder" "amass" "httpx-toolkit"
        "nuclei" "gobuster" "ffuf" "rustscan" "feroxbuster" "dirb" "nikto"
        "sqlmap" "hydra" "john" "hashcat" "steghide" "binwalk" "foremost"
        "exiftool" "strings" "ltrace" "strace" "gdb" "radare2" "ghex" "wireshark"
        "tcpdump" "net-tools" "traceroute" "telnet" "ssh" "openvpn" "proxychains4"
        "tor" "chromium-browser" "firefox" "libssl-dev" "libffi-dev" "libxml2-dev"
        "libxslt1-dev" "zlib1g-dev" "libjpeg-dev" "libpng-dev" "libfreetype6-dev"
        "pkg-config" "cmake" "make" "gcc" "g++" "libc6-dev" "libpcap-dev"
        "libpq-dev" "default-mysql-client" "postgresql-client" "redis-tools"
        "ca-certificates" "gnupg" "lsb-release" "apt-transport-https"
        "software-properties-common"
    )
    
    log_command "sudo apt install -y ${packages[*]}"
}

# Function to install Docker
install_docker() {
    print_status "Installing Docker..."
    
    if command_exists docker; then
        print_info "Docker already installed, skipping..."
        return
    fi
    
    log_command "curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg"
    log_command "echo \"deb [arch=\$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \$(lsb_release -cs) stable\" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null"
    log_command "sudo apt update"
    log_command "sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin"
    log_command "sudo usermod -aG docker \$USER"
    
    print_warning "Please log out and log back in for Docker group changes to take effect"
}

# Function to setup Python environment
setup_python_env() {
    print_status "Setting up Python virtual environment..."
    
    cd "$TOOLS_DIR"
    log_command "python3 -m venv venv"
    
    # Activate virtual environment
    source "$TOOLS_DIR/venv/bin/activate"
    
    # Upgrade pip
    log_command "pip install --upgrade pip setuptools wheel"
    
    # Install common Python packages
    local python_packages=(
        "awscli" "boto3" "botocore" "requests" "urllib3" "beautifulsoup4"
        "selenium" "scrapy" "lxml" "pycryptodome" "cryptography" "paramiko"
        "impacket" "pwntools" "scapy" "netaddr" "ipaddress" "dnspython"
        "python-nmap" "shodan" "censys" "virustotal-api" "GitPython"
        "colorama" "termcolor" "rich" "click" "argparse" "configparser"
        "PyYAML" "python-dateutil" "pytz" "tqdm" "alive-progress"
    )
    
    log_command "pip install ${python_packages[*]}"
}

# Function to install AWS CLI v2
install_aws_cli() {
    print_status "Installing AWS CLI v2..."
    
    if command_exists aws && aws --version | grep -q "aws-cli/2"; then
        print_info "AWS CLI v2 already installed, skipping..."
        return
    fi
    
    cd "$TOOLS_DIR"
    log_command "curl \"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip\" -o \"awscliv2.zip\""
    log_command "unzip awscliv2.zip"
    log_command "sudo ./aws/install --update"
    log_command "rm -rf aws awscliv2.zip"
    
    print_info "AWS CLI version: $(aws --version)"
}

# Function to install Pacu
install_pacu() {
    print_status "Installing Pacu - AWS exploitation framework..."
    
    cd "$TOOLS_DIR"
    source venv/bin/activate
    
    log_command "git clone https://github.com/RhinoSecurityLabs/pacu.git"
    cd pacu
    log_command "pip install -r requirements.txt"
    log_command "python pacu.py --install"
    
    # Create wrapper script
    cat > "$TOOLS_DIR/bin/pacu" << 'EOF'
#!/bin/bash
cd "$HOME/aws-pentest-tools/pacu"
source "$HOME/aws-pentest-tools/venv/bin/activate"
python pacu.py "$@"
EOF
    chmod +x "$TOOLS_DIR/bin/pacu"
}

# Function to install Prowler
install_prowler() {
    print_status "Installing Prowler - AWS security assessment..."
    
    cd "$TOOLS_DIR"
    source venv/bin/activate
    
    log_command "git clone https://github.com/prowler-cloud/prowler.git"
    cd prowler
    log_command "pip install -r requirements.txt"
    
    # Create wrapper script
    cat > "$TOOLS_DIR/bin/prowler" << 'EOF'
#!/bin/bash
cd "$HOME/aws-pentest-tools/prowler"
source "$HOME/aws-pentest-tools/venv/bin/activate"
python prowler.py "$@"
EOF
    chmod +x "$TOOLS_DIR/bin/prowler"
}

# Function to install ScoutSuite
install_scoutsuite() {
    print_status "Installing ScoutSuite - Multi-cloud security auditing..."
    
    cd "$TOOLS_DIR"
    source venv/bin/activate
    
    log_command "git clone https://github.com/nccgroup/ScoutSuite.git"
    cd ScoutSuite
    log_command "pip install -r requirements.txt"
    
    # Create wrapper script
    cat > "$TOOLS_DIR/bin/scout" << 'EOF'
#!/bin/bash
cd "$HOME/aws-pentest-tools/ScoutSuite"
source "$HOME/aws-pentest-tools/venv/bin/activate"
python scout.py "$@"
EOF
    chmod +x "$TOOLS_DIR/bin/scout"
}

# Function to install CloudMapper
install_cloudmapper() {
    print_status "Installing CloudMapper - AWS environment visualization..."
    
    cd "$TOOLS_DIR"
    source venv/bin/activate
    
    log_command "git clone https://github.com/duo-labs/cloudmapper.git"
    cd cloudmapper
    log_command "pip install -r requirements.txt"
    
    # Create wrapper script
    cat > "$TOOLS_DIR/bin/cloudmapper" << 'EOF'
#!/bin/bash
cd "$HOME/aws-pentest-tools/cloudmapper"
source "$HOME/aws-pentest-tools/venv/bin/activate"
python cloudmapper.py "$@"
EOF
    chmod +x "$TOOLS_DIR/bin/cloudmapper"
}

# Function to install S3Scanner
install_s3scanner() {
    print_status "Installing S3Scanner - S3 bucket security scanner..."
    
    cd "$TOOLS_DIR"
    source venv/bin/activate
    
    log_command "git clone https://github.com/sa7mon/S3Scanner.git"
    cd S3Scanner
    log_command "pip install -r requirements.txt"
    
    # Create wrapper script
    cat > "$TOOLS_DIR/bin/s3scanner" << 'EOF'
#!/bin/bash
cd "$HOME/aws-pentest-tools/S3Scanner"
source "$HOME/aws-pentest-tools/venv/bin/activate"
python s3scanner.py "$@"
EOF
    chmod +x "$TOOLS_DIR/bin/s3scanner"
}

# Function to install enumerate-iam
install_enumerate_iam() {
    print_status "Installing enumerate-iam - IAM permission enumeration..."
    
    cd "$TOOLS_DIR"
    source venv/bin/activate
    
    log_command "git clone https://github.com/andresriancho/enumerate-iam.git"
    cd enumerate-iam
    log_command "pip install -r requirements.txt"
    
    # Create wrapper script
    cat > "$TOOLS_DIR/bin/enumerate-iam" << 'EOF'
#!/bin/bash
cd "$HOME/aws-pentest-tools/enumerate-iam"
source "$HOME/aws-pentest-tools/venv/bin/activate"
python enumerate-iam.py "$@"
EOF
    chmod +x "$TOOLS_DIR/bin/enumerate-iam"
}

# Function to install PMMapper
install_pmmapper() {
    print_status "Installing PMMapper - AWS IAM privilege mapping..."
    
    cd "$TOOLS_DIR"
    source venv/bin/activate
    
    log_command "git clone https://github.com/nccgroup/PMapper.git"
    cd PMapper
    log_command "pip install -r requirements.txt"
    log_command "pip install ."
    
    # pmapper should now be available in PATH
}

# Function to install CloudBrute
install_cloudbrute() {
    print_status "Installing CloudBrute - Cloud enumeration tool..."
    
    cd "$TOOLS_DIR"
    log_command "wget https://github.com/0xsha/CloudBrute/releases/latest/download/cloudbrute_linux_amd64.tar.gz"
    log_command "tar -xzf cloudbrute_linux_amd64.tar.gz"
    log_command "mv cloudbrute $TOOLS_DIR/bin/"
    log_command "rm cloudbrute_linux_amd64.tar.gz"
    chmod +x "$TOOLS_DIR/bin/cloudbrute"
}

# Function to install WeirdAAL
install_weirdaal() {
    print_status "Installing WeirdAAL - AWS attack library..."
    
    cd "$TOOLS_DIR"
    source venv/bin/activate
    
    log_command "git clone https://github.com/carnal0wnage/weirdAAL.git"
    cd weirdAAL
    log_command "pip install -r requirements.txt"
    
    # Create wrapper script
    cat > "$TOOLS_DIR/bin/weirdaal" << 'EOF'
#!/bin/bash
cd "$HOME/aws-pentest-tools/weirdAAL"
source "$HOME/aws-pentest-tools/venv/bin/activate"
python weirdAAL.py "$@"
EOF
    chmod +x "$TOOLS_DIR/bin/weirdaal"
}

# Function to install additional Go tools
install_go_tools() {
    print_status "Installing additional Go tools..."
    
    # Set GOPATH
    export GOPATH="$HOME/go"
    export PATH="$PATH:$GOPATH/bin"
    
    # Add to bashrc if not already present
    if ! grep -q "export GOPATH" ~/.bashrc; then
        echo 'export GOPATH="$HOME/go"' >> ~/.bashrc
        echo 'export PATH="$PATH:$GOPATH/bin"' >> ~/.bashrc
    fi
    
    # Install Go tools
    local go_tools=(
        "github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest"
        "github.com/owasp-amass/amass/v4/cmd/amass@latest"
        "github.com/projectdiscovery/httpx/cmd/httpx@latest"
        "github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest"
        "github.com/ffuf/ffuf@latest"
        "github.com/OJ/gobuster/v3@latest"
        "github.com/tomnomnom/assetfinder@latest"
        "github.com/tomnomnom/httprobe@latest"
        "github.com/tomnomnom/waybackurls@latest"
        "github.com/lc/gau/v2/cmd/gau@latest"
    )
    
    for tool in "${go_tools[@]}"; do
        print_info "Installing $tool..."
        log_command "go install $tool"
    done
}

# Function to create useful scripts
create_scripts() {
    print_status "Creating utility scripts..."
    
    # AWS Profile Manager Script
    cat > "$TOOLS_DIR/scripts/aws-profile-manager.sh" << 'EOF'
#!/bin/bash
# AWS Profile Manager

case "$1" in
    "list")
        echo "Available AWS profiles:"
        aws configure list-profiles
        ;;
    "set")
        if [ -z "$2" ]; then
            echo "Usage: $0 set <profile-name>"
            exit 1
        fi
        export AWS_PROFILE="$2"
        echo "AWS_PROFILE set to: $2"
        aws sts get-caller-identity
        ;;
    "current")
        echo "Current AWS profile: ${AWS_PROFILE:-default}"
        aws sts get-caller-identity
        ;;
    *)
        echo "Usage: $0 {list|set <profile>|current}"
        exit 1
        ;;
esac
EOF
    chmod +x "$TOOLS_DIR/scripts/aws-profile-manager.sh"
    
    # S3 Bucket Tester Script
    cat > "$TOOLS_DIR/scripts/s3-bucket-tester.sh" << 'EOF'
#!/bin/bash
# S3 Bucket Security Tester

if [ -z "$1" ]; then
    echo "Usage: $0 <bucket-name-list-file>"
    exit 1
fi

while read -r bucket; do
    echo "Testing bucket: $bucket"
    
    # Test read access
    if aws s3 ls "s3://$bucket" --no-sign-request 2>/dev/null; then
        echo "[CRITICAL] Public read access: $bucket"
    fi
    
    # Test write access
    if echo "test" | aws s3 cp - "s3://$bucket/test-file.txt" --no-sign-request 2>/dev/null; then
        echo "[CRITICAL] Public write access: $bucket"
        aws s3 rm "s3://$bucket/test-file.txt" --no-sign-request 2>/dev/null
    fi
    
    echo "---"
done < "$1"
EOF
    chmod +x "$TOOLS_DIR/scripts/s3-bucket-tester.sh"
    
    # Keycloak Tester Script
    cat > "$TOOLS_DIR/scripts/keycloak-tester.sh" << 'EOF'
#!/bin/bash
# Keycloak Security Tester

KEYCLOAK_URL="$1"

if [ -z "$KEYCLOAK_URL" ]; then
    echo "Usage: $0 <keycloak-url>"
    echo "Example: $0 https://auth.example.com"
    exit 1
fi

echo "Testing Keycloak instance: $KEYCLOAK_URL"

# Test well-known configuration
echo "[*] Checking OpenID configuration..."
curl -s "$KEYCLOAK_URL/auth/realms/master/.well-known/openid_configuration" | jq . 2>/dev/null

# Test admin console access
echo "[*] Checking admin console..."
curl -I "$KEYCLOAK_URL/auth/admin/" 2>/dev/null | head -1

# Test default credentials
echo "[*] Testing default credentials..."
curl -X POST "$KEYCLOAK_URL/auth/realms/master/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin&password=admin&grant_type=password&client_id=admin-cli" \
  2>/dev/null | jq .

# Version detection
echo "[*] Detecting version..."
curl -s "$KEYCLOAK_URL/auth/" | grep -oP 'Keycloak \K[0-9]+\.[0-9]+\.[0-9]+'
EOF
    chmod +x "$TOOLS_DIR/scripts/keycloak-tester.sh"
}

# Function to create wordlists
create_wordlists() {
    print_status "Creating wordlists..."
    
    # Common S3 bucket names
    cat > "$TOOLS_DIR/wordlists/s3-buckets.txt" << 'EOF'
backup
backups
prod
production
dev
development
test
testing
staging
stage
logs
log
data
database
db
files
uploads
downloads
static
assets
images
docs
documents
reports
archive
temp
temporary
private
public
www
web
api
admin
administrator
config
configuration
secrets
keys
EOF
    
    # Common AWS service subdomains
    cat > "$TOOLS_DIR/wordlists/aws-subdomains.txt" << 'EOF'
api
admin
dashboard
console
portal
auth
authentication
login
sso
aws
s3
ec2
rds
lambda
cloudfront
elb
alb
nlb
vpc
iam
cognito
ses
sns
sqs
dynamodb
elasticache
redshift
kinesis
cloudwatch
cloudtrail
config
inspector
guardduty
securityhub
macie
secrets
kms
acm
route53
cloudformation
ecs
eks
fargate
batch
glue
athena
quicksight
sagemaker
comprehend
textract
rekognition
polly
transcribe
translate
lex
connect
chime
workspaces
appsync
amplify
pinpoint
mobilehub
devicefarm
codebuild
codecommit
codedeploy
codepipeline
codestar
cloud9
x-ray
systems-manager
ssm
parameter-store
secrets-manager
certificate-manager
organizations
control-tower
service-catalog
trusted-advisor
support
billing
cost-explorer
budgets
marketplace
license-manager
EOF
}

# Function to setup aliases and PATH
setup_environment() {
    print_status "Setting up environment..."
    
    # Add tools bin directory to PATH
    if ! grep -q "$TOOLS_DIR/bin" ~/.bashrc; then
        echo "export PATH=\"$TOOLS_DIR/bin:\$PATH\"" >> ~/.bashrc
    fi
    
    # Create useful aliases
    if ! grep -q "# AWS Pentest Aliases" ~/.bashrc; then
        cat >> ~/.bashrc << 'EOF'

# AWS Pentest Aliases
alias aws-tools='cd $HOME/aws-pentest-tools'
alias aws-activate='source $HOME/aws-pentest-tools/venv/bin/activate'
alias aws-profile='$HOME/aws-pentest-tools/scripts/aws-profile-manager.sh'
alias s3-test='$HOME/aws-pentest-tools/scripts/s3-bucket-tester.sh'
alias keycloak-test='$HOME/aws-pentest-tools/scripts/keycloak-tester.sh'
alias aws-whoami='aws sts get-caller-identity'
alias aws-regions='aws ec2 describe-regions --query "Regions[*].RegionName" --output text'
EOF
    fi
    
    print_info "Environment setup complete. Source ~/.bashrc or restart terminal to use new aliases."
}

# Function to create desktop shortcuts
create_desktop_shortcuts() {
    print_status "Creating desktop shortcuts..."
    
    mkdir -p ~/.local/share/applications
    
    # Create Pacu desktop shortcut
    cat > ~/.local/share/applications/pacu.desktop << 'EOF'
[Desktop Entry]
Version=1.0
Type=Application
Name=Pacu - AWS Exploitation Framework
Comment=AWS penetration testing framework
Exec=gnome-terminal -- bash -c "source $HOME/aws-pentest-tools/venv/bin/activate && cd $HOME/aws-pentest-tools/pacu && python pacu.py; exec bash"
Icon=utilities-terminal
Terminal=false
Categories=Development;Security;
EOF
    
    # Create Prowler desktop shortcut
    cat > ~/.local/share/applications/prowler.desktop << 'EOF'
[Desktop Entry]
Version=1.0
Type=Application
Name=Prowler - AWS Security Assessment
Comment=AWS security assessment tool
Exec=gnome-terminal -- bash -c "source $HOME/aws-pentest-tools/venv/bin/activate && cd $HOME/aws-pentest-tools/prowler && python prowler.py --help; exec bash"
Icon=utilities-terminal
Terminal=false
Categories=Development;Security;
EOF
}

# Function to run final tests
run_tests() {
    print_status "Running installation tests..."
    
    # Test AWS CLI
    if command_exists aws; then
        print_info "✓ AWS CLI installed: $(aws --version)"
    else
        print_error "✗ AWS CLI not found"
    fi
    
    # Test Python environment
    if [ -f "$TOOLS_DIR/venv/bin/activate" ]; then
        print_info "✓ Python virtual environment created"
    else
        print_error "✗ Python virtual environment not found"
    fi
    
    # Test tools
    local tools=("pacu" "prowler" "scout" "cloudmapper" "s3scanner" "enumerate-iam")
    for tool in "${tools[@]}"; do
        if [ -f "$TOOLS_DIR/bin/$tool" ]; then
            print_info "✓ $tool installed"
        else
            print_warning "! $tool not found"
        fi
    done
    
    # Test Go tools
    export PATH="$PATH:$HOME/go/bin"
    local go_tools=("subfinder" "amass" "httpx" "nuclei" "ffuf" "gobuster")
    for tool in "${go_tools[@]}"; do
        if command_exists "$tool"; then
            print_info "✓ $tool installed"
        else
            print_warning "! $tool not found"
        fi
    done
}

# Function to display usage information
show_usage() {
    print_status "Installation complete!"
    echo
    echo "Tools installed in: $TOOLS_DIR"
    echo "Virtual environment: $TOOLS_DIR/venv"
    echo "Scripts: $TOOLS_DIR/scripts"
    echo "Wordlists: $TOOLS_DIR/wordlists"
    echo
    echo "To get started:"
    echo "1. Source your bashrc: source ~/.bashrc"
    echo "2. Activate Python environment: aws-activate"
    echo "3. Configure AWS credentials: aws configure"
    echo "4. Test with: aws-whoami"
    echo
    echo "Available tools:"
    echo "  • pacu - AWS exploitation framework"
    echo "  • prowler - AWS security assessment"
    echo "  • scout - Multi-cloud security auditing"
    echo "  • cloudmapper - AWS environment visualization"
    echo "  • s3scanner - S3 bucket security scanner"
    echo "  • enumerate-iam - IAM permission enumeration"
    echo "  • pmapper - AWS IAM privilege mapping"
    echo "  • weirdaal - AWS attack library"
    echo "  • cloudbrute - Cloud enumeration"
    echo
    echo "Additional Go tools:"
    echo "  • subfinder, amass, httpx, nuclei, ffuf, gobuster"
    echo
    echo "Utility scripts:"
    echo "  • aws-profile - Manage AWS profiles"
    echo "  • s3-test - Test S3 bucket security"
    echo "  • keycloak-test - Test Keycloak security"
    echo
    echo "For detailed usage, check the main AWS pentesting guide."
    echo
    print_warning "Remember to log out and log back in for Docker group changes to take effect!"
}

# Main installation function
main() {
    print_status "Starting AWS Penetration Testing Tools Installation"
    print_info "This script will install comprehensive AWS pentesting tools on Ubuntu 24.04"
    echo
    
    # Check if running as root
    if [ "$EUID" -eq 0 ]; then
        print_error "Please run this script as a regular user (not root)"
        exit 1
    fi
    
    # Check Ubuntu version
    if ! grep -q "24.04" /etc/os-release; then
        print_warning "This script is designed for Ubuntu 24.04. Proceed with caution."
        read -p "Continue anyway? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
    
    # Start installation
    setup_directories
    update_system
    install_system_dependencies
    install_docker
    setup_python_env
    install_aws_cli
    install_pacu
    install_prowler
    install_scoutsuite
    install_cloudmapper
    install_s3scanner
    install_enumerate_iam
    install_pmmapper
    install_cloudbrute
    install_weirdaal
    install_go_tools
    create_scripts
    create_wordlists
    setup_environment
    create_desktop_shortcuts
    run_tests
    show_usage
    
    print_status "Installation completed successfully!"
    print_info "Log file available at: $LOG_FILE"
}

# Handle script interruption
trap 'print_error "Installation interrupted!"; exit 1' INT TERM

# Run main function
main "$@"