# Keycloak Client Secrets Detection
# Detects exposed client secrets and credentials

id: keycloak-client-secrets

info:
  name: Keycloak Client Secrets Exposure
  author: H1/rfs85
  severity: high
  description: Detects exposed client secrets and OAuth credentials in Keycloak
  reference:
    - https://www.keycloak.org/docs/latest/server_admin/index.html#_clients
  tags: keycloak,client-secrets,oauth,credentials

http:
  - method: GET
    path:
      - "{{BaseURL}}/auth/admin/realms/{{realm}}/clients"
      - "{{BaseURL}}/admin/realms/{{realm}}/clients"
      - "{{BaseURL}}/auth/realms/{{realm}}/clients-registrations/default"
      - "{{BaseURL}}/realms/{{realm}}/clients-registrations/default"

    headers:
      Authorization: "Bearer {{token}}"

    payloads:
      realm:
        - "master"
        - "admin"
        - "internal"
        - "external"
        - "default"
        - "demo"
        - "test"
      token:
        - ""
        - "null"
        - "undefined"

    attack: pitchfork

    matchers:
      - type: word
        part: body
        words:
          - "client_id"
          - "clientId"
          - "secret"
          - "clientSecret"
        condition: or

      - type: status
        status:
          - 200

    extractors:
      - type: json
        name: client_secrets
        part: body
        json:
          - ".[].secret"
          - ".[].clientSecret"
          - ".secret"
          - ".clientSecret"

      - type: json
        name: client_info
        part: body
        json:
          - ".[].clientId"
          - ".[].name"
          - ".clientId"
          - ".name"

  - method: GET
    path:
      - "{{BaseURL}}/auth/realms/{{realm}}/clients-registrations/openid-connect/{{client_id}}"
      - "{{BaseURL}}/realms/{{realm}}/clients-registrations/openid-connect/{{client_id}}"

    payloads:
      realm:
        - "master"
        - "admin"
        - "default"
      client_id:
        - "admin-cli"
        - "account"
        - "security-admin-console"
        - "broker"
        - "realm-management"

    attack: pitchfork

    matchers:
      - type: word
        part: body
        words:
          - "client_secret"
          - "registration_access_token"
        condition: or

      - type: status
        status:
          - 200

    extractors:
      - type: json
        name: registration_tokens
        part: body
        json:
          - ".client_secret"
          - ".registration_access_token"

  - method: POST
    path:
      - "{{BaseURL}}/auth/realms/{{realm}}/protocol/openid-connect/token"
      - "{{BaseURL}}/realms/{{realm}}/protocol/openid-connect/token"

    headers:
      Content-Type: "application/x-www-form-urlencoded"

    body: |
      grant_type=client_credentials&client_id={{client_id}}&client_secret={{client_secret}}

    payloads:
      realm:
        - "master"
        - "admin"
      client_id:
        - "admin-cli"
        - "security-admin-console"
        - "realm-management"
      client_secret:
        - ""
        - "secret"
        - "password"
        - "admin"
        - "keycloak"
        - "client"

    attack: pitchfork

    matchers:
      - type: word
        part: body
        words:
          - "access_token"
          - "token_type"
        condition: and

      - type: status
        status:
          - 200

    extractors:
      - type: json
        name: successful_auth
        part: body
        json:
          - ".access_token"
          - ".scope"
