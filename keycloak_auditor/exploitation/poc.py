from typing import Any, Dict, List

import requests

from ..core.config import AuditorConfig


class ExploitationRunner:
	def __init__(self, config: AuditorConfig):
		self.config = config

	def run(self) -> List[Dict[str, Any]]:
		results: List[Dict[str, Any]] = []
		# Safe demonstration: check if realm endpoint allows open redirect via 'redirect_uri' reflection
		try:
			resp = requests.get(
				f"{self.config.base_url}/realms/{self.config.realm}/protocol/openid-connect/auth",
				params={
					"client_id": "account",
					"redirect_uri": "https://example.com",
					"response_type": "code",
					"scope": "openid",
				},
				timeout=10,
				allow_redirects=False,
			)
			if 300 <= resp.status_code < 400 and "location" in resp.headers:
				location = resp.headers["location"]
				if "https://example.com" in location:
					results.append({
						"id": "potential_open_redirect",
						"title": "Open redirect behavior observed",
						"evidence": location,
						"severity": "low",
					})
		except requests.RequestException:
			pass

		return results
