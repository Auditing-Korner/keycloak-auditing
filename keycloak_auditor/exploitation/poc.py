from typing import Any, Dict, List

import requests

from ..core.config import AuditorConfig
from ..core.http import ThrottledRequester
from ..plugins.manager import PluginManager


class ExploitationRunner:
	def __init__(self, config: AuditorConfig):
		self.config = config
		self.http = ThrottledRequester(config)

	def run(self) -> List[Dict[str, Any]]:
		results: List[Dict[str, Any]] = []
		# Safe demonstration: check if realm endpoint allows open redirect via 'redirect_uri' reflection
		try:
			resp = self.http.request(
				"GET",
				f"{self.config.base_url}/realms/{self.config.realm}/protocol/openid-connect/auth",
				params={
					"client_id": "account",
					"redirect_uri": "https://example.com",
					"response_type": "code",
					"scope": "openid",
				},
				allow_redirects=False,
			)
			if 300 <= resp.status_code < 400 and "location" in resp.headers:
				location = resp.headers["location"]
				if "https://example.com" in location:
					results.append({
						"id": "potential_open_redirect",
						"title": "Open redirect behavior observed",
						"evidence": location,
						"severity": "low",
					})
		except Exception:
			pass

		# Run exploitation plugins
		try:
			plugin_manager = PluginManager(self.config)
			plugin_manager.load_plugins()
			plugin_results = plugin_manager.run_exploitation_plugins()
			results.extend(plugin_results)
		except Exception:
			pass

		return results
